generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Papéis do sistema para RBAC.
enum Role {
  ADMIN       // Acesso total (Gestão de usuários, configurações)
  ENGENHEIRO  // Cria obras, medições, diários, orçamentos
  FISCAL      // Aprova medições, visualiza tudo
  CONVIDADO   // Apenas visualização limitada (padrão)
}

/// Usuários do sistema.
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String   // Hashed
  role      Role     @default(CONVIDADO)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[] // Logs gerados por este usuário
  obras     Obra[]     // Obras sob responsabilidade deste usuário
}

/// Log de auditoria para rastreabilidade de mudanças críticas.
model AuditLog {
  id        String   @id @default(uuid())
  entity    String   // Nome da entidade (ex: "User", "Obra")
  entityId  String   // ID da entidade afetada
  action    String   // CREATE, UPDATE, DELETE
  oldValue  Json?    // Valor anterior (snapshot)
  newValue  Json?    // Novo valor (snapshot)
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
}

enum ObraStatus {
  PLANEJAMENTO
  LICITACAO
  EXECUCAO
  PARALISADA
  CONCLUIDA
}

/// Tipo macro da obra (ex: construção, reforma).
enum ObraTipo {
  CONSTRUCAO
  REFORMA
  INSTALACAO
  ELETRICA
  HIDRAULICA
  INFRAESTRUTURA
  CIVIL
  OUTRO
}

/// Classificação do endereço para relatórios.
enum ObraEnderecoTipo {
  URBANO
  RURAL
}

/// Estratégia de BDI usada no orçamento.
enum ObraBdiTipo {
  UNICO
  DIFERENCIADO
}

/// Origem principal do recurso financeiro.
enum ObraRecursoTipo {
  PROPRIO
  MISTO
  FEDERAL
  ESTADUAL
}

model Obra {
  id                  String     @id @default(uuid())
  nome                String
  /// Título curto exibido em relatórios.
  titulo              String?
  /// Tipo macro da obra.
  tipo                ObraTipo   @default(CONSTRUCAO)
  descricao           String?
  localizacao         String
  /// Tipo do endereço (urbano/rural).
  enderecoTipo        ObraEnderecoTipo?
  /// Logradouro principal da obra.
  enderecoLogradouro  String?
  /// Número do endereço.
  enderecoNumero      String?
  /// Bairro da obra.
  enderecoBairro      String?
  /// CEP do endereço.
  enderecoCep         String?
  status              ObraStatus @default(PLANEJAMENTO)
  dataInicio          DateTime
  dataPrevisaoTermino DateTime
  /// Área construída em m².
  construidoM2        Decimal?   @db.Decimal(12, 2)
  /// Responsável textual (quando não vinculado a usuário).
  responsavelNome     String?
  /// Estratégia de BDI aplicada.
  bdiTipo             ObraBdiTipo? @default(UNICO)
  /// BDI único em percentual.
  bdiUnicoPercent     Decimal?     @db.Decimal(5, 2)
  /// BDI diferenciado para material.
  bdiMaterialPercent  Decimal?     @db.Decimal(5, 2)
  /// BDI diferenciado para equipamento.
  bdiEquipamentoPercent Decimal?   @db.Decimal(5, 2)
  /// BDI diferenciado para mão de obra.
  bdiMaoDeObraPercent Decimal?     @db.Decimal(5, 2)
  /// BDI diferenciado para serviço.
  bdiServicoPercent   Decimal?     @db.Decimal(5, 2)
  /// BDI diferenciado para taxa.
  bdiTaxaPercent      Decimal?     @db.Decimal(5, 2)
  /// Desconto aplicado ao BDI.
  bdiDescontoPercent  Decimal?     @db.Decimal(5, 2)
  /// Valor total estimado da obra.
  valorTotalObra      Decimal?     @db.Decimal(15, 2)
  /// Valor total do convênio.
  valorTotalConvenio  Decimal?     @db.Decimal(15, 2)
  /// Nome do convênio.
  convenio            String?
  /// Indicação parlamentar ou referência de origem.
  indicacao           String?
  /// Origem principal do recurso.
  recurso             ObraRecursoTipo? @default(PROPRIO)
  /// Indica se há contrapartida financeira.
  possuiContrapartida Boolean     @default(false)
  /// Valor da contrapartida.
  valorContrapartida  Decimal?     @db.Decimal(15, 2)
  /// Avanço financeiro em percentual.
  avancoFinanceiroPercent Decimal? @db.Decimal(5, 2) @default(0)
  /// Avanço físico em percentual.
  avancoFisicoPercent Decimal?     @db.Decimal(5, 2) @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  responsavelId String?
  responsavel   User?   @relation(fields: [responsavelId], references: [id])

  orcamentos    Orcamento[]
  dotacoes      ObraDotacao[]
}

/// Dotação orçamentária vinculada a uma obra.
model ObraDotacao {
  id              String @id @default(uuid())
  /// Projeto ou atividade de origem.
  projetoAtividade String
  /// Código reduzido para classificação.
  codigoReduzido  String
  /// Natureza da despesa associada.
  naturezaDespesa String

  obraId String
  obra   Obra   @relation(fields: [obraId], references: [id], onDelete: Cascade)

  @@index([obraId])
}

/// Tabela de referência (ex: SINAPI 01/2026, SICRO, PRÓPRIA).
model TabelaReferencia {
  id        String   @id @default(uuid())
  nome      String   // ex: "SINAPI - JAN/2026 - NAO DESONERADO"
  mes       Int
  ano       Int
  createdAt DateTime @default(now())

  insumos     Insumo[]
  composicoes Composicao[]
}

enum TipoInsumo {
  MATERIAL
  MAO_DE_OBRA
  EQUIPAMENTO
  SERVICO
}

/// Insumo básico (ex: Cimento, Servente).
model Insumo {
  id        String     @id @default(uuid())
  codigo    String     // Codigo na tabela origem
  descricao String
  unidade   String
  preco     Decimal    @db.Decimal(10, 2)
  tipo      TipoInsumo

  tabelaId String
  tabela   TabelaReferencia @relation(fields: [tabelaId], references: [id], onDelete: Cascade)

  itemsComposicao ItemComposicao[]
  itemsOrcamento  ItemOrcamento[]

  @@index([codigo])
}

/// Composição (ex: "Concreto Fck 25MPa").
model Composicao {
  id         String   @id @default(uuid())
  codigo     String
  descricao  String
  unidade    String
  precoTotal Decimal  @db.Decimal(10, 2) // Cache da soma dos itens

  tabelaId String
  tabela   TabelaReferencia @relation(fields: [tabelaId], references: [id], onDelete: Cascade)

  itens           ItemComposicao[] @relation("ComposicaoPai")
  usoEmComposicao ItemComposicao[] @relation("ComposicaoFilha")
  usoEmOrcamento  ItemOrcamento[]

  @@index([codigo])
}

/// Item de uma composição (Pode ser Insumo ou outra Composição).
model ItemComposicao {
  id String @id @default(uuid())

  quantidade Decimal @db.Decimal(12, 4) // Coeficiente

  composicaoPaiId String
  composicaoPai   Composicao @relation("ComposicaoPai", fields: [composicaoPaiId], references: [id], onDelete: Cascade)

  // Um item aponta para UM Insumo OU UMA Composicao (recursivo)
  insumoId String?
  insumo   Insumo? @relation(fields: [insumoId], references: [id], onDelete: Cascade)

  composicaoFilhaId String?
  composicaoFilha   Composicao? @relation("ComposicaoFilha", fields: [composicaoFilhaId], references: [id], onDelete: Cascade)
}

/// Orçamento de uma Obra.
model Orcamento {
  id   String @id @default(uuid())
  nome String // ex: "Orçamento Base", "Revisão 1"

  dataBaseMonth Int
  dataBaseYear  Int

  bdi      Decimal? @default(0) @db.Decimal(5, 2)
  encargos Decimal? @default(0) @db.Decimal(5, 2)
  total    Decimal  @default(0) @db.Decimal(15, 2)

  obraId String
  obra   Obra   @relation(fields: [obraId], references: [id])

  etapas    Etapa[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Etapa do orçamento (ex: "1. Infraestrutura").
model Etapa {
  id     String @id @default(uuid())
  ordem  Int    // 1, 2, 3...
  nome   String // "Infraestrutura"
  
  orcamentoId String
  orcamento   Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)

  itens ItemOrcamento[]
}

/// Item do orçamento (Linha da planilha).
model ItemOrcamento {
  id     String @id @default(uuid())
  ordem  Int    // 1.1, 1.2...

  // Snapshot dos dados (para histórico não mudar se a tabela mudar)
  codigo        String
  descricao     String
  unidade       String
  quantidade    Decimal @db.Decimal(12, 4)
  valorUnitario Decimal @db.Decimal(10, 2)
  valorTotal    Decimal @db.Decimal(15, 2)

  origem String // SINAPI, PROPRIA, COTACAO

  etapaId String
  etapa   Etapa  @relation(fields: [etapaId], references: [id], onDelete: Cascade)

  // Opcional: Link para a origem para rastreabilidade
  insumoId String?
  insumo   Insumo? @relation(fields: [insumoId], references: [id])

  composicaoId String?
  composicao   Composicao? @relation(fields: [composicaoId], references: [id])
}
